# 一、整体接口分层（先给你全局视图）

```
API Layer
└── /generate/reply

Service Layer
├── SceneAnalysisService      (LLM)
├── PersonaInferenceService   (LLM)
├── ReplyGenerationService    (LLM)
├── IntimacyCheckService      (LLM)
├── LLMAdapter                (统一出口)
├── BillingService            (token & cost)
└── PersonaUpdateService

Persistence Layer
├── conversation_history
├── scene_analysis_log
├── persona_snapshot
├── llm_call_log
├── intimacy_check_log
└── generation_result
```

------

# 二、对外 API 定义（生成对话入口）

## 2.1 生成建议接口

```
POST /api/v1/generate/reply
Content-Type: application/json
```

### Request

```
{
  "user_id": "u_123",
  "target_id": "t_456",
  "conversation_id": "c_789",
  "language": "es-ES",
  "quality": "normal",
  "force_regenerate": false
}
```

### Response

```
{
  "reply_text": "可以这样回复：我也觉得今天聊得挺轻松的。",
  "confidence": 0.81,
  "intimacy_level_before": 3,
  "intimacy_level_after": 4,
  "model": "gpt-5-mini",
  "provider": "openai",
  "cost_usd": 0.0023
}
```

------

# 三、Service 层接口定义（重点）

------

## 3.1 SceneAnalysisService（场景分析 · LLM）

```
interface SceneAnalysisInput {
  conversation_id: string
  history_dialog: Message[]
  emotion_trend: EmotionSummary
}

interface SceneAnalysisResult {
  scene: "破冰" | "推进" | "冷却" | "维持"
  intimacy_level: number        // 1-5
  risk_flags: string[]
}
analyzeScene(input: SceneAnalysisInput): SceneAnalysisResult
```

------

## 3.2 PersonaInferenceService（用户画像推理 · LLM）

```
interface PersonaInferenceInput {
  user_id: string
  conversation_id: string
  scene: string
  history_dialog: Message[]
}

interface PersonaSnapshot {
  style: "理性" | "感性" | "幽默" | "克制"
  pacing: "slow" | "normal" | "fast"
  risk_tolerance: "low" | "medium" | "high"
  confidence: number
}
inferPersona(input: PersonaInferenceInput): PersonaSnapshot
```

------

## 3.3 ReplyGenerationService（回复生成 · LLM）

```
interface ReplyGenerationInput {
  prompt: string
  quality: "cheap" | "normal" | "premium"
}
generateReply(input: ReplyGenerationInput): LLMResult
```

------

## 3.4 IntimacyCheckService（亲密度检查 · LLM）

```
interface IntimacyCheckInput {
  reply_text: string
  intimacy_level: number
  persona: PersonaSnapshot
}
interface IntimacyCheckResult {
  pass: boolean
  score: number
  reason?: string
}
check(input: IntimacyCheckInput): IntimacyCheckResult
```

------

## 3.5 LLMAdapter（**唯一 LLM 出口**）

```
interface LLMCall {
  task_type: "scene" | "persona" | "generation" | "qc"
  prompt: string
  quality: "cheap" | "normal" | "premium"
}
interface LLMResult {
  text: string
  provider: string
  model: string
  input_tokens: number
  output_tokens: number
  cost_usd: number
}
call(call: LLMCall): LLMResult
```

------

# 四、数据表设计（可直接建库）

------

## 4.1 历史对话表（已存在，但给标准）

```
conversation_history
--------------------
id (pk)
conversation_id
user_id
target_id
speaker          -- user / target
content
timestamp
```

------

## 4.2 场景分析记录

```
scene_analysis_log
------------------
id (pk)
conversation_id
scene
intimacy_level
risk_flags (json)
model
provider
created_at
```

------

## 4.3 用户画像快照（核心）

```
persona_snapshot
----------------
id (pk)
user_id
conversation_id
style
pacing
risk_tolerance
confidence
created_at
```

> ⚠️ **注意：不是覆盖，而是快照**
>  这是你未来“画像演进”的金矿

------

## 4.4 LLM 调用日志（计费核心）

```
llm_call_log
------------
id (pk)
user_id
task_type
provider
model
input_tokens
output_tokens
cost_usd
latency_ms
created_at
```

------

## 4.5 亲密度检查日志

```
intimacy_check_log
------------------
id (pk)
conversation_id
reply_text
pass
score
reason
model
created_at
```

------

## 4.6 生成结果表（最终输出）

```
generation_result
-----------------
id (pk)
conversation_id
reply_text
intimacy_before
intimacy_after
model
provider
cost_usd
created_at
```

------

# 五、强烈建议你这样拆任务（工程视角）

### 后端（1 人）

- LLMAdapter
- BillingService
- 生成流程编排

### Prompt / 策略（1 人）

- Scene Prompt
- Persona Prompt
- QC Prompt

### 产品 / 数据（你）

- intimacy_level 定义
- QC pass/fail 标准