# 《生成对话子系统技术框架文档》

**Conversation Generation Subsystem – Technical Design**

------

## 1. 子系统定位

### 1.1 职责定义

生成对话子系统的核心职责是：

> **在给定用户画像、历史对话、情绪趋势与当前目标的前提下，生成“可控、合规、关系阶段匹配”的对话回复建议，并通过质量闭环持续优化。**

本子系统 **不负责**：

- OCR / 排版
- 情绪识别算法实现
- 多模态输入解析

------

### 1.2 输入 / 输出边界

#### 输入（已完成的分析对话系统提供）

```
{
  "user_id": "u_123",
  "target_id": "t_456",
  "history_dialog": [...],
  "emotion_trend": {...},
  "language": "es-ES",
  "timestamp": 1730000000
}
```

#### 输出（给前端或上层系统）

```
{
  "suggested_reply": "文本内容",
  "confidence_score": 0.82,
  "intimacy_level_delta": +1,
  "used_model": "gpt-5-mini",
  "cost_usd": 0.0021
}
```

------

## 2. 总体架构

```mathematica
┌──────────────┐
│  生成请求入口 │
└──────┬───────┘
       ▼
┌──────────────────┐
│ Context Builder  │  ← 资料库
│ (资料整合)        │
└──────┬───────────┘
       ▼
┌──────────────────┐
│ Prompt Assembler │
└──────┬───────────┘
       ▼
┌──────────────────┐
│ Reply Generator  │  ← AI生成建议回复
│ (LLM Adapter)    │
└──────┬───────────┘
       ▼
┌──────────────────┐
│ Intimacy Checker │  ← AI亲密度检测
└──────┬─────┬─────┘
       │     │
     Pass   Fail
       │     │
       ▼     │
┌──────────────┐   │
│ Response Out │   │
└──────┬───────┘   │
       ▼           │
┌──────────────────┐
│ Persona Updater  │ ← YHHX
└──────────────────┘
                 │
                 └── 回退重新生成

```

------

## 3. 核心模块说明

------

## 3.1 Context Builder（资料整合服务）

### 职责

- 汇总所有**非生成型事实**
- 对上下文进行裁剪、摘要、排序
- 生成 Prompt 所需的 **结构化上下文**

### 输入

- 历史对话（最近 N 轮 + 关键节点）
- 情绪趋势（最近 3–5 条）
- 用户画像（当前状态）
- 当前目标（如“破冰 / 推进 / 维持”）

### 输出

```
{
  "conversation_summary": "...",
  "emotion_state": "positive",
  "current_intimacy_level": 3,
  "risk_flags": ["too_fast"]
}
```

------

## 3.2 Prompt Assembler（Prompt 组装器）

### 设计原则

- Prompt **结构固定**
- 内容由 Context 填充
- 禁止在 Prompt 中放不可信推断

### Prompt 模板示例

```
System:
你是一个对话建议助手，不是对话发言人。

Context:
- 当前关系等级: {{intimacy_level}}
- 情绪趋势: {{emotion_trend}}
- 风险提示: {{risk_flags}}

History:
{{conversation_summary}}

Task:
生成一条符合当前关系阶段、不冒进、不油腻的回复建议。
```

------

## 3.3 Reply Generator（对话回复建议服务 SR）

### 定位

- **候选生成器**
- 不保证一定可用
- 可多次调用

### 技术实现

- 基于 **统一 LLMAdapter**
- 支持多模型路由（成本 / 质量）

### 接口

```
generateReply(prompt, quality): LLMRawResponse
```

------

## 3.4 统一 LLMAdapter

### 目标

- 对上层隐藏平台差异
- 支持热切换模型
- 支持实时 token & 成本统计

### Adapter 接口

```
interface LLMAdapter {
  generate(prompt): {
    text,
    input_tokens,
    output_tokens,
    model,
    provider
  }
}
```

------

## 3.5 Intimacy Checker（亲密度检测 QC）

### 职责

- 判断生成内容是否：
  - 超过当前关系阶段
  - 存在情感操纵风险
  - 不符合用户人设

### 输出

```
{
  "pass": true,
  "score": 0.78,
  "reason": null
}
```

### 失败处理

- 标记失败原因
- 反馈给 Prompt Assembler
- 自动触发再生成（最多 N 次）

------

## 3.6 Persona Updater（用户画像更新）

### 更新内容

- 用户对 AI 建议的采纳率
- 关系推进成功 / 失败
- 偏好风格变化

### 更新策略

- 只在 QC 通过后更新
- 支持回滚

------

## 4. Token 监控 & 实时计费

### 统一结构

```
{
  "user_id": "...",
  "provider": "openai",
  "model": "gpt-5-mini",
  "input_tokens": 320,
  "output_tokens": 86,
  "cost_usd": 0.0019,
  "timestamp": 1730000000
}
```

### 作用

- 用户额度控制
- 成本分析
- 模型 ROI 对比

------

## 5. 失败 & 回退策略

| 场景            | 处理方式             |
| --------------- | -------------------- |
| LLM 超时        | 切换低级模型         |
| QC 连续失败     | 降级输出「保守建议」 |
| 成本超限        | 强制 cheap 模型      |
| Prompt 构造失败 | 返回人工模板         |

------

## 6. 非功能性要求

- P95 延迟 < 2s
- 单请求成本可配置上限
- 每次生成可完整回溯（prompt / model / cost）